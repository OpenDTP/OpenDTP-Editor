
function MapEditor(t,i){var n,e=[],r=[];this.load=function(t,i){this.map=new DocumentMap(i),this.editors.push(new Editor(t,this.map,this.plugins))},this.__defineGetter__("map",function(){return n}),this.__defineGetter__("plugins",function(){return r}),this.__defineGetter__("editors",function(){return e}),this.__defineSetter__("map",function(t){n=t}),void 0!==t&&void 0!==i&&this.load(t,i)}var MAPEDITOR=new MapEditor;!function(t){return t.fn.mapeditor=function(t){for(var i=0;i<this.length;i++)MAPEDITOR.load(this[i],t)},this}(jQuery);
function DocumentMap(t){var e=0,n=0,i=0,s=0,r="",o=[],_=[],a=0,h=["mm","cm","px"];this.load=function(t){var e=t.spreads.length;this.width=t.width,this.height=t.height,this.unit=t.unit,this.dpi=t.dpi,this.name=t.name,this.preview=t.preview;for(var n=0;e>n;n++)this.spreads.push(new Spread(t.spreads[n]));for(var n=this.spreads.length-1;n>=0;n--)for(var i in this.spreads[n].pages){a++;for(var s in this.spreads[n].pages[i].blocs)-1===$.inArray(this.spreads[n].pages[i].blocs[s].type,this.blocs_type)&&this.blocs_type.push(this.spreads[n].pages[i].blocs[s].type)}},this.__defineGetter__("width",function(){return e}),this.__defineGetter__("height",function(){return n}),this.__defineGetter__("unit",function(){return i}),this.__defineGetter__("dpi",function(){return s}),this.__defineGetter__("name",function(){return r}),this.__defineGetter__("spreads",function(){return o}),this.__defineGetter__("blocs_type",function(){return _}),this.__defineGetter__("nb_pages",function(){return a}),this.__defineSetter__("width",function(t){var n=parseFloat(t);0/0===n?(console.log("DocumentMap : Warning width value is not a number, setting width to 0"),e=0):e=n}),this.__defineSetter__("height",function(t){var e=parseFloat(t);0/0===e?(console.log("DocumentMap : Warning height value is not a number, setting height to 0"),n=0):n=e}),this.__defineSetter__("unit",function(t){-1===$.inArray(t,h)?(console.log("DocumentMap : Warning unknown unit "+t+", using mm unit"),i="mm"):i=t}),this.__defineSetter__("dpi",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap : Warning unknown unit, setting DPI to 72 (low definition)"),s=72):s=parsed}),this.__defineSetter__("name",function(t){r=t}),void 0!==t&&this.load(t)}
function Spread(e){var i={},n=0;this.load=function(e){if(void 0!==e)for(var i in e)this.pages[i]=new Page(i,e[i]),n++},this.__defineGetter__("pages",function(){return i}),this.__defineGetter__("nb_pages",function(){return n}),void 0!==e&&this.load(e)}
function Page(e,t){var i,n="",_="",r={},o=0;this.load=function(e,t){this.name=e,this.preview=t.preview,this.type=t.type;for(key in t.blocs)this.blocs[key]=new Bloc(key,t.blocs[key]),o++},this.__defineGetter__("name",function(){return i}),this.__defineGetter__("type",function(){return _}),this.__defineGetter__("preview",function(){return n}),this.__defineGetter__("blocs",function(){return r}),this.__defineGetter__("nb_blocs",function(){return o}),this.__defineSetter__("name",function(e){i=e}),this.__defineSetter__("type",function(e){_=e}),this.__defineSetter__("preview",function(e){n=e}),void 0!==e&&void 0!==t&&this.load(e,t)}
function Bloc(t,e){var n="undefined",i=0,_=0,r=0,o=0,s="none",d="",h=!1;this.load=function(t,e){this.name=t,this.width=e.width,this.height=e.height,this.x=e.x,this.y=e.y,this.type=e.type,this.content=e.content},this.__defineGetter__("name",function(){return n}),this.__defineGetter__("width",function(){return i}),this.__defineGetter__("height",function(){return _}),this.__defineGetter__("x",function(){return r}),this.__defineGetter__("y",function(){return o}),this.__defineGetter__("type",function(){return s}),this.__defineGetter__("content",function(){return d}),this.__defineGetter__("updated",function(){return h}),this.__defineSetter__("width",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),i=0):i=parsed}),this.__defineSetter__("height",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),_=0):_=parsed}),this.__defineSetter__("x",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting x to 0"),r=0):r=parsed}),this.__defineSetter__("y",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting y to 0"),o=72):o=parsed}),this.__defineSetter__("type",function(t){s=t}),this.__defineSetter__("name",function(t){n=t}),this.__defineSetter__("content",function(t){d=t}),this.__defineSetter__("updated",function(t){h=t}),void 0!==t&&void 0!==e&&this.load(n,e)}
function Renderer(t,e){this.node=t,this.map=e,this.zoom=1,this.load=function(){this.node=t,this.map=e,this.zoom=1},this.render=function(t,e){var i;void 0===t&&(t=0),!0===e&&$(this.node).html("");var a,h,s,o,d;for(var n in this.map.spreads[t].pages){i=this.createSVG("svg",{height:"100%",width:"100%"}),d=this.map.spreads[t].pages[n];for(var r in d.blocs)a=d.blocs[r].x/this.map.width*100,h=d.blocs[r].y/this.map.height*100,s=d.blocs[r].width/this.map.width*100,o=d.blocs[r].height/this.map.height*100,i.append(this.createSVG("rect",{x:a.toFixed(2)+"%",y:h.toFixed(2)+"%",width:s.toFixed(2)+"%",height:o.toFixed(2)+"%","class":"bloc bloc-"+d.blocs[r].type,"data-name":r,"data-spread":t,"data-page":n}));i.css("background-image",'url("'+d.preview+'")'),$(this.node).append(i)}this.resizeMap(),i.find(".bloc").click(i,function(t){$(t.target);t.shiftKey||$(t.data).find(".bloc").each(function(){$(this).attr("class",$(this).attr("class").replace(" selected",""))}),-1===$(t.target).attr("class").indexOf("selected")&&$(t.target).attr("class",$(t.target).attr("class")+" selected")}),i.click(function(t){$(t.target).find(".bloc").each(function(){$(this).attr("class",$(this).attr("class").replace(" selected",""))})}),this.node.trigger("change")},this.resizeMap=function(t){var e=void 0===t?this:t.data,i=$(e.node).find("svg"),a=$(i[0]).outerWidth()-$(i[0]).width(),h=$(i[0]).outerHeight()-$(i[0]).height(),s=$(e.node).width(),o=$(e.node).height(),d=e.map.width*i.length/e.map.height,n=s/o;d>n?($(i).attr("width",s/i.length*this.zoom-a+"px"),$(i).attr("height",(s/d*this.zoom).toFixed(0)-h+"px")):($(i).attr("height",o*this.zoom-h+"px"),$(i).attr("width",(o*d/i.length*this.zoom).toFixed(0)-a+"px"))},this.filter=function(t){var e=$(this.node).find("svg");"all"!==t&&e.find(".bloc").hide(),"none"!==t&&"all"!==t&&e.find(".bloc-"+t).show(),"all"===t&&e.find(".bloc").show()},this.createSVG=function(t,e){var i=$(document.createElementNS("http://www.w3.org/2000/svg",t));for(var a in e)i.attr(a,e[a]);return i}}

MAPEDITOR.plugins.push(function(){var t="text";this.load=function(){CKEDITOR.disableAutoInline=!0},this.loadEvents=function(t){t.renderer.node.find(".bloc.bloc-text").click(t,function(t){var a=parseInt($(this).attr("data-spread")),e=$(this).attr("data-page"),n=$(this).attr("data-name");t.data.clearPopup(),t.data.ckeditorPopup(t.data.map.spreads[a].pages[e].blocs[n].content)})},this.__defineGetter__("name",function(){return t}),this.__defineSetter__("name",function(a){t=a})});
MAPEDITOR.plugins.push(function(){var n="hand";this.load=function(){},this.__defineGetter__("name",function(){return n}),this.__defineSetter__("name",function(t){n=t})});
MAPEDITOR.plugins.push(function(){this.name="flatplan",this.max_width=50,this.flatplan=$('<div class="flatplan"></div>'),this.flatplan_content=$('<div class="flatplan-content"></div>'),this.load=function(a){var t=$('<div class="header"><di class="title">Flatplan<div></div>'),s=$('<div class="hide-toggle">&gt;</div>');t.prepend(s),this.flatplan_content.append(t),this.flatplan_content.append(this.flatplan),this.loadFlatplan(a),a.viewports.preview.node.append(this.flatplan_content),t.click({flatplan:this.flatplan,hide:s},function(a){a.data.flatplan.toggle(),$(a.data.flatplan).is(":visible")?$(a.data.hide).removeClass("show"):$(a.data.hide).addClass("show")})},this.loadFlatplan=function(a){for(var t,s,e,p,d=a.map.spreads.length,i=0;d>i;i++){p=a.map.spreads[i].pages.length,s=$('<div class="spread" data-index="'+i+'"></div>'),e=1/a.map.spreads[i].nb_pages*100,e=e>this.max_width?this.max_width:e;for(var n in a.map.spreads[i].pages)t=$('<div class="page"><img class="page" src="'+a.map.spreads[i].pages[n].preview+'" width="100%" /></div>'),t.css("width",e.toFixed(2)+"%"),("left"===a.map.spreads[i].pages[n].type||"right"===a.map.spreads[i].pages[n].type)&&t.addClass(a.map.spreads[i].pages[n].type),s.append(t);s.click(a,function(a){var t=$(a.target);a.data.properties.current_spread=void 0===t.attr("data-index")?parseInt(t.parents(".spread").attr("data-index")):parseInt(t.attr("data-index")),a.data.renderer.render(a.data.properties.current_spread,!0)}),this.flatplan.append(s)}}});
MAPEDITOR.plugins.push(function(){this.name="zoom",this.slider=$('<div class="zoom-slider"></div>'),this.step=10,this.load=function(e){var s=$('<div class="zoom"></div>'),i=$('<div class="zoom-plus"></div>'),t=$('<div class="zoom-moins"></div>');this.slider.slider({min:25,max:200,step:1,value:100}),this.slider.on("slide",e,this.update),i.click(this,function(e){e.data.zoom(step)}),t.click(this,function(e){e.data.zoom(-step)}),this.bindWheelevent(e),s.append(i),s.append(this.slider),s.append(t),e.viewports.footer.node.append(s)},this.bindWheelevent=function(e){var s=this,i=function(e){e.preventDefault(),0>e.deltaY?s.zoom(-step):s.zoom(step)};e.viewports.map.node[0].addEventListener?(e.viewports.map.node[0].addEventListener("mousewheel",i,!1),e.viewports.map.node[0].addEventListener("DOMMouseScroll",i,!1)):e.viewports.map.node[0].attachEvent("onmousewheel",i)},this.update=function(e,s){100<s.value?e.data.renderer.node.css("overflow","auto"):e.data.renderer.node.css("overflow","none"),e.data.renderer.zoom=s.value/100,e.data.renderer.resizeMap()},this.zoom=function(e){this.slider.slider("value",this.slider.slider("value")+e),this.slider.trigger("slide",{value:this.slider.slider("value")})}});
MAPEDITOR.plugins.push(function(){this.name="pages",this.load=function(e){var r=$('<div class="pages"></div>'),t=$('<span class="max">'+e.map.spreads.length+"</span>"),a=$('<span class="separator">/</span>'),p=$('<span class="current">'+(e.properties.current_spread+1)+"</span>"),d=$('<a href="#">&gt</a>'),n=$('<a href="#">&lt;</a>');d.click({editor:e,current:p},function(e){e.preventDefault(),e.data.editor.properties.current_spread<e.data.editor.map.spreads.length-1&&(e.data.editor.properties.current_spread++,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0)),e.data.current.html(e.data.editor.properties.current_spread+1)}),n.click({editor:e,current:p},function(e){e.preventDefault(),e.data.editor.properties.current_spread>0&&(e.data.editor.properties.current_spread--,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0))}),e.renderer.node.change({editor:e,current:p},function(e){e.data.current.html(e.data.editor.properties.current_spread+1)}),r.append(n),r.append(p),r.append(a),r.append(t),r.append(d),e.viewports.footer.node.append(r)}});
MAPEDITOR.plugins.push(function(){this.name="filter",this.load=function(e){var n=$('<div class="filter"></div>'),o=$("<select></select>");o.append($('<option value="all">all</option>')),o.append($('<option value="none">none</option>'));for(var p=e.map.blocs_type.length-1;p>=0;p--)o.append($('<option value="'+e.map.blocs_type[p]+'">'+e.map.blocs_type[p]+"</option>"));o.on("change",e,function(e){e.data.renderer.filter($(e.target).val())}),n.append(o),e.viewports.footer.node.prepend(n)}});
function Editor(e,i,t){this.node=null,this.map=null,this.renderer=null,this.viewports={header:new HeaderViewport,toolbar:new ToolbarViewport,map:new MapViewport,preview:new PreviewViewport,footer:new FooterViewport,popup:new PopupViewport},this.properties={current_spread:0},this.menu_items={File:{},Edit:{},View:{"Show / Hide right pannel":function(e){e.right_pannel.toggle(),e.right_pannel.is(":visible")?e.map_viewport.addClass("right-space"):e.map_viewport.removeClass("right-space")},"Show / Hide left pannel":function(e){e.left_pannel.toggle(),e.left_pannel.is(":visible")?e.map_viewport.addClass("left-space"):e.map_viewport.removeClass("left-space")}},Help:{About:function(){alert("the fucking awesome editor\nPACO Editor v0.1")}}},this.plugins=[],this.load=function(e,i,t){this.node=$(e),this.map=i,this.node.addClass("mapeditor");for(var o in this.viewports)!0===this.viewports[o].active&&(this.viewports[o].load(this),!1===this.viewports[o].displayed&&this.viewports[o].hide());this.mapResize(),void 0!==t&&t.length>0&&this.loadPlugins(t),$(window).resize(this,this.mapResize)},this.mapResize=function(e){var i=void 0===e?this:e.data,t=i.viewports,o=t.map.node.find(".map-wrapper"),n=(t.map.node.outerWidth(!0)-t.map.node.width(),t.map.node.outerHeight(!0)-t.map.node.height());t.map.node.css("height",i.node.height()-t.header.node.outerHeight(!0)-t.footer.node.outerHeight(!0)-n),t.toolbar.node.css("height",i.node.height()-t.header.node.outerHeight(!0)-t.footer.node.outerHeight(!0)),t.preview.node.css("height",i.node.height()-t.header.node.outerHeight(!0)-t.footer.node.outerHeight(!0)),$(o).css("line-height",t.map.node.height()+"px"),i.renderer.resizeMap(),i.node.trigger("change")},this.loadPlugins=function(e){for(var i,t=e.length-1;t>=0;t--)i=new e[t],console.log(i.name),i.load(this),this.plugins.push(i)},void 0!==e&&void 0!==i&&this.load(e,i,t)}
function AbstractViewport(i,t){this.active=void 0===i?!0:i,this.displayed=void 0===t?!0:t,this.node=null,this.editor=null,this.hide=function(){this.node.hide()},this.show=function(){this.node.show()}}
function MapViewport(e,t){this.base=AbstractViewport,this.base(e,t),this.load=function(e){var t;this.node=$('<div class="map-viewport right-space left-space"></div>'),t=$('<div class="map-wrapper"></div>'),this.editor=e,this.node.append(t),this.editor.node.append(this.node),this.editor.renderer=new Renderer(t,this.editor.map),this.editor.renderer.render(this.editor.properties.current_spread)}}MapViewport.prototype=new AbstractViewport;
function HeaderViewport(e,t){this.base=AbstractViewport,this.base(e,t),this.menu_node=$('<div class="menu"></div>'),this.load=function(e){this.editor=e,this.node=$('<div class="header"><div class="title">PACO Editor v0.1</div><div class="version-wrapper"><div class="version">'+this.editor.map.name+"</div></div></div>"),this.menu(),this.node.append(this.menu_node),this.editor.node.append(this.node)},this.menu=function(e){var t;!0===e&&this.menu_node.html("");for(var i in this.editor.menu_items)t=$('<div class="menu-item">'+i+"</div>"),this.menuRecurse(t,this.editor.menu_items[i]),this.menu_node.append(t)},this.menuRecurse=function(e,t){var i,n=$("<ul></ul>");for(var s in t)submenu_element=$("<li>"+s+"</li>"),"function"==typeof t[s]&&submenu_element.click({editor:this,element:t[s]},function(e){e.data.element(e.data.editor)}),n.append(submenu_element);i=function(e){$(e.target).hasClass("selected")||e.data.showMenu(e.target)},e.click(this,function(e){e.data.showMenu(e.target),e.data.menu_node.find(".menu-item").mouseenter(e.data,i)}),this.node.mouseleave(this,function(e){e.data.hideMenu(),e.data.menu_node.find(".menu-item").unbind("mouseenter",i)}),n.hide(),e.append(n)},this.showMenu=function(e){this.hideMenu(),$(e).addClass("selected"),$(e).find("ul").show()},this.hideMenu=function(){this.menu_node.find("ul").hide(),this.menu_node.find(".menu-item").removeClass("selected")}}HeaderViewport.prototype=new AbstractViewport;
function ToolbarViewport(t,o){this.base=AbstractViewport,this.base(t,o),this.load=function(t){this.node=$('<div class="toolbar"></div>'),this.editor=t,this.editor.node.append(this.node)}}ToolbarViewport.prototype=new AbstractViewport;
function PreviewViewport(t,i){this.base=AbstractViewport,this.base(t,i),this.load=function(t){this.node=$('<div class="right-pannel"></div>'),this.editor=t,this.editor.node.append(this.node)}}PreviewViewport.prototype=new AbstractViewport;
function FooterViewport(t,o){this.base=AbstractViewport,this.base(t,o),this.load=function(t){this.node=$('<div class="footer"></div>'),this.editor=t,this.editor.node.append(this.node)}}FooterViewport.prototype=new AbstractViewport;
function PopupViewport(e,t){this.base=AbstractViewport,this.base(e,t),this.load=function(e){this.node=$('<div class="popup-overlay"></div><div class="popup-content"></div>'),this.editor=e,this.editor.node.append(this.node),this.node[0].click(this,function(e){e.data.hidePopup()})},this.clearPopup=function(){$(this.node).find(".popup-content").html("")},this.hidePopup=function(){$(this.node).find(".popup-content, .popup-overlay").hide()},this.displayPopup=function(){$(this.node).find(".popup-content, .popup-overlay").show()},this.ckeditorPopup=function(e){this.clearPopup();var e=$(this.node).find(".popup-content").append("<textarea>"+(void 0===e?"":e)+"</textarea>");$(e).find("textarea").ckeditor({resize_enabled:!1,removePlugins:"elementspath",height:"100%",width:"100%",toolbar:[{name:"document",groups:["mode","document","doctools"],items:["Source","-","Save","Preview"]},{name:"styles",items:["Styles"]},{name:"basicstyles",groups:["basicstyles","cleanup"],items:["RemoveFormat"]},{name:"insert",items:["SpecialChar"]},{name:"tools",items:["Maximize","ShowBlocks"]}]}),this.displayPopup()}}ToolbarViewport.prototype=new AbstractViewport;