
function MapEditor(t,i){var n,e=[],r=[];this.load=function(t,i){this.map=new DocumentMap(i),this.editors.push(new Editor(t,this.map,this.plugins))},this.__defineGetter__("map",function(){return n}),this.__defineGetter__("plugins",function(){return r}),this.__defineGetter__("editors",function(){return e}),this.__defineSetter__("map",function(t){n=t}),void 0!==t&&void 0!==i&&this.load(t,i)}var MAPEDITOR=new MapEditor;!function(t){return t.fn.mapeditor=function(t){for(var i=0;i<this.length;i++)MAPEDITOR.load(this[i],t)},this}(jQuery);
function DocumentMap(t){var e=0,n=0,i=0,s=0,r="",o=[],_=[],a=0,h=["mm","cm","px"];this.load=function(t){var e=t.spreads.length;this.width=t.width,this.height=t.height,this.unit=t.unit,this.dpi=t.dpi,this.name=t.name,this.preview=t.preview;for(var n=0;e>n;n++)this.spreads.push(new Spread(t.spreads[n]));for(var n=this.spreads.length-1;n>=0;n--)for(var i in this.spreads[n].pages){a++;for(var s in this.spreads[n].pages[i].blocs)-1===$.inArray(this.spreads[n].pages[i].blocs[s].type,this.blocs_type)&&this.blocs_type.push(this.spreads[n].pages[i].blocs[s].type)}},this.__defineGetter__("width",function(){return e}),this.__defineGetter__("height",function(){return n}),this.__defineGetter__("unit",function(){return i}),this.__defineGetter__("dpi",function(){return s}),this.__defineGetter__("name",function(){return r}),this.__defineGetter__("spreads",function(){return o}),this.__defineGetter__("blocs_type",function(){return _}),this.__defineGetter__("nb_pages",function(){return a}),this.__defineSetter__("width",function(t){var n=parseFloat(t);0/0===n?(console.log("DocumentMap : Warning width value is not a number, setting width to 0"),e=0):e=n}),this.__defineSetter__("height",function(t){var e=parseFloat(t);0/0===e?(console.log("DocumentMap : Warning height value is not a number, setting height to 0"),n=0):n=e}),this.__defineSetter__("unit",function(t){-1===$.inArray(t,h)?(console.log("DocumentMap : Warning unknown unit "+t+", using mm unit"),i="mm"):i=t}),this.__defineSetter__("dpi",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap : Warning unknown unit, setting DPI to 72 (low definition)"),s=72):s=parsed}),this.__defineSetter__("name",function(t){r=t}),void 0!==t&&this.load(t)}
function Spread(e){var i={},n=0;this.load=function(e){if(void 0!==e)for(var i in e)this.pages[i]=new Page(i,e[i]),n++},this.__defineGetter__("pages",function(){return i}),this.__defineGetter__("nb_pages",function(){return n}),void 0!==e&&this.load(e)}
function Page(e,t){var i,n="",_="",r={},o=0;this.load=function(e,t){this.name=e,this.preview=t.preview,this.type=t.type;for(key in t.blocs)this.blocs[key]=new Bloc(key,t.blocs[key]),o++},this.__defineGetter__("name",function(){return i}),this.__defineGetter__("type",function(){return _}),this.__defineGetter__("preview",function(){return n}),this.__defineGetter__("blocs",function(){return r}),this.__defineGetter__("nb_blocs",function(){return o}),this.__defineSetter__("name",function(e){i=e}),this.__defineSetter__("type",function(e){_=e}),this.__defineSetter__("preview",function(e){n=e}),void 0!==e&&void 0!==t&&this.load(e,t)}
function Bloc(t,e){var n="undefined",i=0,_=0,r=0,o=0,s="none",d="",h=!1;this.load=function(t,e){this.name=t,this.width=e.width,this.height=e.height,this.x=e.x,this.y=e.y,this.type=e.type,this.content=e.content},this.__defineGetter__("name",function(){return n}),this.__defineGetter__("width",function(){return i}),this.__defineGetter__("height",function(){return _}),this.__defineGetter__("x",function(){return r}),this.__defineGetter__("y",function(){return o}),this.__defineGetter__("type",function(){return s}),this.__defineGetter__("content",function(){return d}),this.__defineGetter__("updated",function(){return h}),this.__defineSetter__("width",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),i=0):i=parsed}),this.__defineSetter__("height",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),_=0):_=parsed}),this.__defineSetter__("x",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting x to 0"),r=0):r=parsed}),this.__defineSetter__("y",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting y to 0"),o=72):o=parsed}),this.__defineSetter__("type",function(t){s=t}),this.__defineSetter__("name",function(t){n=t}),this.__defineSetter__("content",function(t){d=t}),this.__defineSetter__("updated",function(t){h=t}),void 0!==t&&void 0!==e&&this.load(n,e)}
function Renderer(t,e){this.node=t,this.map=e,this.zoom=1,this.load=function(){this.node=t,this.map=e,this.zoom=1},this.render=function(t,e){var i;void 0===t&&(t=0),!0===e&&$(this.node).html("");var a,h,s,o,d;for(var n in this.map.spreads[t].pages){i=this.createSVG("svg",{height:"100%",width:"100%"}),d=this.map.spreads[t].pages[n];for(var r in d.blocs)a=d.blocs[r].x/this.map.width*100,h=d.blocs[r].y/this.map.height*100,s=d.blocs[r].width/this.map.width*100,o=d.blocs[r].height/this.map.height*100,i.append(this.createSVG("rect",{x:a.toFixed(2)+"%",y:h.toFixed(2)+"%",width:s.toFixed(2)+"%",height:o.toFixed(2)+"%","class":"bloc bloc-"+d.blocs[r].type,"data-name":r,"data-spread":t,"data-page":n}));i.css("background-image",'url("'+d.preview+'")'),$(this.node).append(i)}this.resizeMap(),i.find(".bloc").click(i,function(t){$(t.target);t.shiftKey||$(t.data).find(".bloc").each(function(){$(this).attr("class",$(this).attr("class").replace(" selected",""))}),-1===$(t.target).attr("class").indexOf("selected")&&$(t.target).attr("class",$(t.target).attr("class")+" selected")}),i.click(function(t){$(t.target).find(".bloc").each(function(){$(this).attr("class",$(this).attr("class").replace(" selected",""))})}),this.node.trigger("change")},this.resizeMap=function(t){var e=void 0===t?this:t.data,i=$(e.node).find("svg"),a=$(i[0]).outerWidth()-$(i[0]).width(),h=$(i[0]).outerHeight()-$(i[0]).height(),s=$(e.node).width(),o=$(e.node).height(),d=e.map.width*i.length/e.map.height,n=s/o;d>n?($(i).attr("width",s/i.length*this.zoom-a+"px"),$(i).attr("height",(s/d*this.zoom).toFixed(0)-h+"px")):($(i).attr("height",o*this.zoom-h+"px"),$(i).attr("width",(o*d/i.length*this.zoom).toFixed(0)-a+"px"))},this.filter=function(t){var e=$(this.node).find("svg");"all"!==t&&e.find(".bloc").hide(),"none"!==t&&"all"!==t&&e.find(".bloc-"+t).show(),"all"===t&&e.find(".bloc").show()},this.createSVG=function(t,e){var i=$(document.createElementNS("http://www.w3.org/2000/svg",t));for(var a in e)i.attr(a,e[a]);return i}}

MAPEDITOR.plugins.push(function(){var t="text";this.load=function(){CKEDITOR.disableAutoInline=!0},this.loadEvents=function(t){t.renderer.node.find(".bloc.bloc-text").click(t,function(t){var a=parseInt($(this).attr("data-spread")),e=$(this).attr("data-page"),n=$(this).attr("data-name");t.data.clearPopup(),t.data.ckeditorPopup(t.data.map.spreads[a].pages[e].blocs[n].content)})},this.__defineGetter__("name",function(){return t}),this.__defineSetter__("name",function(a){t=a})});
MAPEDITOR.plugins.push(function(){var n="hand";this.load=function(){},this.__defineGetter__("name",function(){return n}),this.__defineSetter__("name",function(t){n=t})});
MAPEDITOR.plugins.push(function(){var a,t,e="flatplan",n=50;this.load=function(e){var n=$('<div class="header"><di class="title">Flatplan<div></div>'),s=$('<div class="hide-toggle">&gt;</div>');a=$('<div class="flatplan"></div>'),t=$('<div class="flatplan-content"></div>'),n.prepend(s),this.flatplan_content.append(n),this.flatplan_content.append(this.flatplan),this.loadFlatplan(e),e.right_pannel.append(this.flatplan_content),n.click({flatplan:this.flatplan,hide:s},function(a){a.data.flatplan.toggle(),$(a.data.flatplan).is(":visible")?$(a.data.hide).removeClass("show"):$(a.data.hide).addClass("show")})},this.loadFlatplan=function(a){for(var t,e,s,i,d=a.map.spreads.length,p=0;d>p;p++){i=a.map.spreads[p].pages.length,e=$('<div class="spread" data-index="'+p+'"></div>'),s=1/a.map.spreads[p].nb_pages*100,s=s>this.max_width?n:s;for(var r in a.map.spreads[p].pages)t=$('<div class="page"><img class="page" src="'+a.map.spreads[p].pages[r].preview+'" width="100%" /></div>'),t.css("width",s.toFixed(2)+"%"),("left"===a.map.spreads[p].pages[r].type||"right"===a.map.spreads[p].pages[r].type)&&t.addClass(a.map.spreads[p].pages[r].type),e.append(t);e.click(a,function(a){var t=$(a.target);a.data.properties.current_spread=void 0===t.attr("data-index")?parseInt(t.parents(".spread").attr("data-index")):parseInt(t.attr("data-index")),a.data.renderer.render(a.data.properties.current_spread,!0)}),this.flatplan.append(e)}},this.__defineGetter__("name",function(){return e}),this.__defineGetter__("max_width",function(){return n}),this.__defineGetter__("flatplan",function(){return a}),this.__defineGetter__("flatplan_content",function(){return t}),this.__defineSetter__("name",function(a){e=a}),this.__defineSetter__("max_width",function(a){n=a})});
MAPEDITOR.plugins.push(function(){var e="zoom",t=$('<div class="zoom-slider"></div>'),i=10;this.load=function(e){var t=$('<div class="zoom"></div>'),n=$('<div class="zoom-plus"></div>'),s=$('<div class="zoom-moins"></div>');this.slider.slider({min:25,max:200,step:1,value:100}),this.slider.on("slide",e,this.update),n.click(this,function(e){e.data.zoom(i)}),s.click(this,function(e){e.data.zoom(-i)}),this.bindWheelevent(e),t.append(n),t.append(this.slider),t.append(s),e.footer.append(t)},this.bindWheelevent=function(e){for(var t=this,n=function(e){e.preventDefault(),0>e.deltaY?t.zoom(-i):t.zoom(i)},s=e.map_viewport.length-1;s>=0;s--)e.map_viewport[s].addEventListener?(e.map_viewport[s].addEventListener("mousewheel",n,!1),e.map_viewport[s].addEventListener("DOMMouseScroll",n,!1)):e.map_viewport[s].attachEvent("onmousewheel",n)},this.update=function(e,t){100<t.value?e.data.renderer.node.css("overflow","auto"):e.data.renderer.node.css("overflow","none"),e.data.renderer.zoom=t.value/100,e.data.renderer.resizeMap()},this.zoom=function(e){this.slider.slider("value",this.slider.slider("value")+e),this.slider.trigger("slide",{value:this.slider.slider("value")})},this.__defineGetter__("name",function(){return e}),this.__defineGetter__("slider",function(){return t}),this.__defineGetter__("step",function(){return i}),this.__defineSetter__("name",function(t){e=t}),this.__defineSetter__("step",function(e){i=e})});
MAPEDITOR.plugins.push(function(){var e="pages";this.load=function(e){var r=$('<div class="pages"></div>'),t=$('<span class="max">'+e.map.spreads.length+"</span>"),a=$('<span class="separator">/</span>'),n=$('<span class="current">'+(e.properties.current_spread+1)+"</span>"),p=$('<a href="#">&gt</a>'),d=$('<a href="#">&lt;</a>');p.click({editor:e,current:n},function(e){e.preventDefault(),e.data.editor.properties.current_spread<e.data.editor.map.spreads.length-1&&(e.data.editor.properties.current_spread++,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0)),e.data.current.html(e.data.editor.properties.current_spread+1)}),d.click({editor:e,current:n},function(e){e.preventDefault(),e.data.editor.properties.current_spread>0&&(e.data.editor.properties.current_spread--,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0))}),e.renderer.node.change({editor:e,current:n},function(e){e.data.current.html(e.data.editor.properties.current_spread+1)}),r.append(d),r.append(n),r.append(a),r.append(t),r.append(p),e.footer.append(r)},this.__defineGetter__("name",function(){return e}),this.__defineSetter__("name",function(r){e=r})});
MAPEDITOR.plugins.push(function(){var e="filter";this.load=function(e){var n=$('<div class="filter"></div>'),t=$("<select></select>");t.append($('<option value="all">all</option>')),t.append($('<option value="none">none</option>'));for(var o=e.map.blocs_type.length-1;o>=0;o--)t.append($('<option value="'+e.map.blocs_type[o]+'">'+e.map.blocs_type[o]+"</option>"));t.on("change",e,function(e){e.data.renderer.filter($(e.target).val())}),n.append(t),e.footer.prepend(n)},this.__defineGetter__("name",function(){return e}),this.__defineSetter__("name",function(n){e=n})});
function Editor(e,t,i){this.node=null,this.map=null,this.renderer=null,this.viewports={header:new HeaderViewport,toolbar:new ToolbarViewport,map:new MapViewport};var o;this.properties={current_spread:0};this.load=function(e,t){this.node=$(e),this.map=t,this.node.addClass("mapeditor");for(var i in this.viewports)!0===this.viewports[i].active&&(this.viewports[i].load(this),!1===this.viewports[i].displayed&&this.viewports[i].hide())},this.loadMenu=function(e,t){var i,o=$("<ul></ul>");for(var n in t)submenu_element=$("<li>"+n+"</li>"),"function"==typeof t[n]&&submenu_element.click({editor:this,element:t[n]},function(e){e.data.element(e.data.editor)}),o.append(submenu_element);i=function(e){$(e.target).hasClass("selected")||e.data.showMenu(e.target)},e.click(this,function(e){e.data.showMenu(e.target),e.data.menu.find(".menu-item").mouseenter(e.data,i)}),this.toolbar.mouseleave(this,function(e){e.data.hideMenu(),e.data.menu.find(".menu-item").unbind("mouseenter",i)}),o.hide(),e.append(o)},this.showMenu=function(e){this.hideMenu(),$(e).addClass("selected"),$(e).find("ul").show()},this.hideMenu=function(){this.menu.find("ul").hide(),this.menu.find(".menu-item").removeClass("selected")},this.loadFooter=function(){o=$('<div class="footer"></div>'),this.node.append(this.footer)},this.mapViewport=function(){var e;e=$('<div class="map-wrapper"></div>'),this.map_viewport.append(e),this.toolbar.after(this.map_viewport),renderer=new Renderer(e,this.map),this.renderer.render(this.properties.current_spread)},this.mapResize=function(t){var i=void 0===t?this:t.data,o=i.map_viewport.find(".map-wrapper"),n=(i.map_viewport.outerWidth(!0)-i.map_viewport.width(),i.map_viewport.outerHeight(!0)-i.map_viewport.height());i.map_viewport.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)-n),i.left_pannel.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)),i.right_pannel.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)),$(o).css("line-height",$(o).height()+"px"),i.renderer.resizeMap(),e.trigger("change")},this.loadPlugins=function(e){for(var t,i=e.length-1;i>=0;i--)t=new e[i],t.load(this),this.plugins.push(t)},this.clearPopup=function(){$(this.node).find(".popup-content").html("")},this.hidePopup=function(){$(this.node).find(".popup-content, .popup-overlay").hide()},this.displayPopup=function(){$(this.node).find(".popup-content, .popup-overlay").show()},this.ckeditorPopup=function(e){this.clearPopup();var e=$(this.node).find(".popup-content").append("<textarea>"+(void 0===e?"":e)+"</textarea>");$(e).find("textarea").ckeditor({resize_enabled:!1,removePlugins:"elementspath",height:"100%",width:"100%",toolbar:[{name:"document",groups:["mode","document","doctools"],items:["Source","-","Save","Preview"]},{name:"styles",items:["Styles"]},{name:"basicstyles",groups:["basicstyles","cleanup"],items:["RemoveFormat"]},{name:"insert",items:["SpecialChar"]},{name:"tools",items:["Maximize","ShowBlocks"]}]}),this.displayPopup()},void 0!==e&&void 0!==t&&this.load(e,t,i)}
function AbstractViewport(i,t){this.active=void 0===i?!0:i,this.displayed=void 0===t?!0:t,this.node=null,this.editor=null,this.hide=function(){this.node.hide()},this.show=function(){this.node.show()}}
function MapViewport(e,t){this.base=AbstractViewport,this.base(e,t),this.load=function(e){var t;this.node=$('<div class="map-viewport right-space left-space"></div>'),t=$('<div class="map-wrapper"></div>'),this.editor=e,this.node.append(t),this.editor.node.append(this.node),this.editor.renderer=new Renderer(t,this.editor.map),this.editor.renderer.render(this.editor.properties.current_spread)}}MapViewport.prototype=new AbstractViewport;
function HeaderViewport(e,i){this.base=AbstractViewport,this.base(e,i),this.load=function(e){this.node=$('<div class="header"><div class="title">PACO Editor v0.1</div><div class="version-wrapper"><div class="version">'+e.map.name+"</div></div></div>"),e.node.append(this.node)}}HeaderViewport.prototype=new AbstractViewport;
function ToolbarViewport(t,o){this.base=AbstractViewport,this.base(t,o),this.load=function(t){this.node=$('<div class="toolbar"></div>'),this.editor=t,this.editor.node.append(this.node)}}ToolbarViewport.prototype=new AbstractViewport;
