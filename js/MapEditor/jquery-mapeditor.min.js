
function MapEditor(t,i){var n,e=[],r=[];this.load=function(t,i){this.map=new DocumentMap(i),this.editors.push(new Editor(t,this.map,this.plugins))},this.__defineGetter__("map",function(){return n}),this.__defineGetter__("plugins",function(){return r}),this.__defineGetter__("editors",function(){return e}),this.__defineSetter__("map",function(t){n=t}),void 0!==t&&void 0!==i&&this.load(t,i)}var MAPEDITOR=new MapEditor;!function(t){return t.fn.mapeditor=function(t){for(var i=0;i<this.length;i++)MAPEDITOR.load(this[i],t)},this}(jQuery);
function DocumentMap(t){var e=0,n=0,i=0,s=0,r="",o=[],_=[],a=0,h=["mm","cm","px"];this.load=function(t){var e=t.spreads.length;this.width=t.width,this.height=t.height,this.unit=t.unit,this.dpi=t.dpi,this.name=t.name,this.preview=t.preview;for(var n=0;e>n;n++)this.spreads.push(new Spread(t.spreads[n]));for(var n=this.spreads.length-1;n>=0;n--)for(var i in this.spreads[n].pages){a++;for(var s in this.spreads[n].pages[i].blocs)-1===$.inArray(this.spreads[n].pages[i].blocs[s].type,this.blocs_type)&&this.blocs_type.push(this.spreads[n].pages[i].blocs[s].type)}},this.__defineGetter__("width",function(){return e}),this.__defineGetter__("height",function(){return n}),this.__defineGetter__("unit",function(){return i}),this.__defineGetter__("dpi",function(){return s}),this.__defineGetter__("name",function(){return r}),this.__defineGetter__("spreads",function(){return o}),this.__defineGetter__("blocs_type",function(){return _}),this.__defineGetter__("nb_pages",function(){return a}),this.__defineSetter__("width",function(t){var n=parseFloat(t);0/0===n?(console.log("DocumentMap : Warning width value is not a number, setting width to 0"),e=0):e=n}),this.__defineSetter__("height",function(t){var e=parseFloat(t);0/0===e?(console.log("DocumentMap : Warning height value is not a number, setting height to 0"),n=0):n=e}),this.__defineSetter__("unit",function(t){-1===$.inArray(t,h)?(console.log("DocumentMap : Warning unknown unit "+t+", using mm unit"),i="mm"):i=t}),this.__defineSetter__("dpi",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap : Warning unknown unit, setting DPI to 72 (low definition)"),s=72):s=parsed}),this.__defineSetter__("name",function(t){r=t}),void 0!==t&&this.load(t)}
function Spread(e){var i={},n=0;this.load=function(e){if(void 0!==e)for(var i in e)this.pages[i]=new Page(i,e[i]),n++},this.__defineGetter__("pages",function(){return i}),this.__defineGetter__("nb_pages",function(){return n}),void 0!==e&&this.load(e)}
function Page(e,t){var i,n="",_={},r=0;this.load=function(e,t){this.name=e,this.preview=t.preview;for(key in t.blocs)this.blocs[key]=new Bloc(key,t.blocs[key]),r++},this.__defineGetter__("name",function(){return i}),this.__defineGetter__("preview",function(){return n}),this.__defineGetter__("blocs",function(){return _}),this.__defineGetter__("nb_blocs",function(){return r}),this.__defineSetter__("name",function(e){i=e}),this.__defineSetter__("preview",function(e){n=e}),void 0!==e&&void 0!==t&&this.load(e,t)}
function Bloc(t,e){var n="undefined",i=0,_=0,r=0,o=0,s="none",d="",h=!1;this.load=function(t,e){this.name=t,this.width=e.width,this.height=e.height,this.x=e.x,this.y=e.y,this.type=e.type,this.content=e.content},this.__defineGetter__("name",function(){return n}),this.__defineGetter__("width",function(){return i}),this.__defineGetter__("height",function(){return _}),this.__defineGetter__("x",function(){return r}),this.__defineGetter__("y",function(){return o}),this.__defineGetter__("type",function(){return s}),this.__defineGetter__("content",function(){return d}),this.__defineGetter__("updated",function(){return h}),this.__defineSetter__("width",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),i=0):i=parsed}),this.__defineSetter__("height",function(t){parsed=parseFloat(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting height to 0"),_=0):_=parsed}),this.__defineSetter__("x",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting x to 0"),r=0):r=parsed}),this.__defineSetter__("y",function(t){parsed=parseInt(t),0/0===parsed?(console.log("DocumentMap Object : Warning width value is not a number, setting y to 0"),o=72):o=parsed}),this.__defineSetter__("type",function(t){s=t}),this.__defineSetter__("name",function(t){n=t}),this.__defineSetter__("content",function(t){d=t}),this.__defineSetter__("updated",function(t){h=t}),void 0!==t&&void 0!==e&&this.load(n,e)}
function RendererAbstract(t,e){var n,i,_;this.load=function(t,e){this.node=t,this.map=e,this.zoom=1},this.createSVG=function(t,e){var n=$(document.createElementNS("http://www.w3.org/2000/svg",t));for(var i in e)n.attr(i,e[i]);return n},this.__defineGetter__("map",function(){return n}),this.__defineGetter__("node",function(){return i}),this.__defineGetter__("map_svg",function(){return map_svg}),this.__defineGetter__("zoom",function(){return _}),this.__defineSetter__("map",function(t){n=t}),this.__defineSetter__("node",function(t){i=t}),this.__defineSetter__("map_svg",function(t){map_svg=t}),this.__defineSetter__("zoom",function(t){_=t}),void 0!==t&&void 0!==e&&this.load(t,e)}
function Renderer(t,i){RendererAbstract.call(this,t,i),this.render=function(t,i){var e;void 0===t&&(t=0),!0===i&&$(this.node).html("");var h,a,s,o,d;for(var n in this.map.spreads[t].pages){e=this.createSVG("svg",{height:"100%",width:"100%"}),d=this.map.spreads[t].pages[n];for(var r in d.blocs)h=d.blocs[r].x/this.map.width*100,a=d.blocs[r].y/this.map.height*100,s=d.blocs[r].width/this.map.width*100,o=d.blocs[r].height/this.map.height*100,e.append(this.createSVG("rect",{x:h.toFixed(2)+"%",y:a.toFixed(2)+"%",width:s.toFixed(2)+"%",height:o.toFixed(2)+"%","class":"bloc bloc-"+d.blocs[r].type,"data-name":r,"data-spread":t,"data-page":n}));e.css("background-image",'url("'+d.preview+'")'),$(this.node).append(e)}this.resizeMap(),this.node.trigger("change")},this.resizeMap=function(t){var i=void 0===t?this:t.data,e=$(i.node).find("svg"),h=$(e[0]).outerWidth()-$(e[0]).width(),a=$(e[0]).outerHeight()-$(e[0]).height(),s=$(i.node).width(),o=$(i.node).height(),d=i.map.width*e.length/i.map.height,n=s/o;d>n?($(e).attr("width",s/e.length*this.zoom-h+"px"),$(e).attr("height",(s/d*this.zoom).toFixed(0)-a+"px")):($(e).attr("height",o*this.zoom-a+"px"),$(e).attr("width",(o*d/e.length*this.zoom).toFixed(0)-h+"px"))},this.filter=function(t){var i=$(this.node).find("svg");"all"!==t&&i.find(".bloc").hide(),"none"!==t&&"all"!==t&&i.find(".bloc-"+t).show(),"all"===t&&i.find(".bloc").show()}}

MAPEDITOR.plugins.push(function(){var t="text";this.load=function(t){CKEDITOR.disableAutoInline=!0,this.loadEvents(t),t.renderer.node.change({editor:t,plugin:this},function(e){t.renderer.node.find(".bloc.bloc-text").unbind("click",e.data.plugin.loadEvents),e.data.plugin.loadEvents(e.data.editor)})},this.loadEvents=function(t){t.renderer.node.find(".bloc.bloc-text").click(t,function(t){var e=parseInt($(this).attr("data-spread")),n=$(this).attr("data-page"),a=$(this).attr("data-name");t.data.clearPopup(),t.data.ckeditorPopup(t.data.map.spreads[e].pages[n].blocs[a].content)})},this.__defineGetter__("name",function(){return t}),this.__defineSetter__("name",function(e){t=e})});
MAPEDITOR.plugins.push(function(){var t,a,e="flatplan",n=33.3333;this.load=function(e){var n=$('<div class="header"><di class="title">Flatplan<div></div>'),i=$('<div class="hide-toggle">&gt;</div>');t=$('<div class="flatplan"></div>'),a=$('<div class="flatplan-content"></div>'),n.prepend(i),this.flatplan_content.append(n),this.flatplan_content.append(this.flatplan),this.loadFlatplan(e),e.right_pannel.append(this.flatplan_content),i.click(this.flatplan,function(t){t.data.toggle(),$(t.data).is(":visible")?$(t.target).removeClass("show"):$(t.target).addClass("show")})},this.loadFlatplan=function(t){for(var a,e,i,s,d=t.map.spreads.length,r=0;d>r;r++){s=t.map.spreads[r].pages.length,e=$('<div class="spread" data-index="'+r+'"></div>'),i=1/t.map.spreads[r].nb_pages*100,i=i>this.max_width?n:i;for(var p in t.map.spreads[r].pages)a=$('<div class="page"><img class="page" src="'+t.map.spreads[r].pages[p].preview+'" width="100%" /></div>'),a.css("width",i.toFixed(2)+"%"),e.append(a);e.click(t,function(t){var a=$(t.target);t.data.properties.current_spread=void 0===a.attr("data-index")?parseInt(a.parents(".spread").attr("data-index")):parseInt(a.attr("data-index")),t.data.renderer.render(t.data.properties.current_spread,!0)}),this.flatplan.append(e)}},this.__defineGetter__("name",function(){return e}),this.__defineGetter__("max_width",function(){return n}),this.__defineGetter__("flatplan",function(){return t}),this.__defineGetter__("flatplan_content",function(){return a}),this.__defineSetter__("name",function(t){e=t}),this.__defineSetter__("max_width",function(t){n=t})});
MAPEDITOR.plugins.push(function(){var e="zoom";this.load=function(e){var a=$('<div class="zoom"></div>'),d=$('<div class="zoom-plus"></div>'),i=$('<div class="zoom-moins"></div>'),t=$('<div class="zoom-slider"></div>');t.slider({min:25,max:200,step:1,value:100}),t.on("slide",e,this.update),d.click(t,function(e){e.data.slider("value",e.data.slider("value")+10),e.data.trigger("slide",{value:e.data.slider("value")})}),i.click(t,function(e){e.data.slider("value",e.data.slider("value")-10),e.data.trigger("slide",{value:e.data.slider("value")})}),a.append(d),a.append(t),a.append(i),e.footer.append(a)},this.update=function(e,a){100<a.value?e.data.renderer.node.css("overflow","auto"):e.data.renderer.node.css("overflow","none"),e.data.renderer.zoom=a.value/100,e.data.renderer.resizeMap()},this.__defineGetter__("name",function(){return e}),this.__defineSetter__("name",function(a){e=a})});
MAPEDITOR.plugins.push(function(){var e="pages";this.load=function(e){var r=$('<div class="pages"></div>'),t=$('<span class="max">'+e.map.spreads.length+"</span>"),a=$('<span class="separator">/</span>'),n=$('<span class="current">'+(e.properties.current_spread+1)+"</span>"),p=$('<a href="#">&gt</a>'),d=$('<a href="#">&lt;</a>');p.click({editor:e,current:n},function(e){e.preventDefault(),e.data.editor.properties.current_spread<e.data.editor.map.spreads.length-1&&(e.data.editor.properties.current_spread++,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0)),e.data.current.html(e.data.editor.properties.current_spread+1)}),d.click({editor:e,current:n},function(e){e.preventDefault(),e.data.editor.properties.current_spread>0&&(e.data.editor.properties.current_spread--,e.data.editor.renderer.render(e.data.editor.properties.current_spread,!0))}),e.renderer.node.change({editor:e,current:n},function(e){e.data.current.html(e.data.editor.properties.current_spread+1)}),r.append(d),r.append(n),r.append(a),r.append(t),r.append(p),e.footer.append(r)},this.__defineGetter__("name",function(){return e}),this.__defineSetter__("name",function(r){e=r})});
MAPEDITOR.plugins.push(function(){var e="filter";this.load=function(e){var n=$('<div class="filter"></div>'),t=$("<select></select>");t.append($('<option value="all">all</option>')),t.append($('<option value="none">none</option>'));for(var o=e.map.blocs_type.length-1;o>=0;o--)t.append($('<option value="'+e.map.blocs_type[o]+'">'+e.map.blocs_type[o]+"</option>"));t.on("change",e,function(e){e.data.renderer.filter($(e.target).val())}),n.append(t),e.footer.prepend(n)},this.__defineGetter__("name",function(){return e}),this.__defineSetter__("name",function(n){e=n})});
function Editor(e,t,i){var e,t,n,o,s,a,r,d,p,h={current_spread:0},u={File:{},Edit:{},View:{"Show / Hide right pannel":function(e){e.right_pannel.toggle(),e.right_pannel.is(":visible")?e.map_viewport.addClass("right-space"):e.map_viewport.removeClass("right-space")},"Show / Hide left pannel":function(e){e.left_pannel.toggle(),e.left_pannel.is(":visible")?e.map_viewport.addClass("left-space"):e.map_viewport.removeClass("left-space")}},Help:{About:function(){alert("the fucking awesome editor\nPACO Editor v0.1")}}},l=[];this.load=function(e,t,i){var n;this.node=$(e),r=$('<div class="menu"></div>'),o=$('<div class="toolbar"><div class="title">PACO Editor v0.1</div><div class="name-wrapper"><div class="name">'+this.map.name+"</div></div></div>"),s=$('<div class="map-viewport right-space left-space"></div>'),d=$('<div class="left-pannel"></div>'),p=$('<div class="right-pannel"></div>'),this.node.addClass("mapeditor"),this.node.append(this.toolbar),this.loadFooter(),this.mapViewport(),this.map_viewport.before(d),this.map_viewport.after(p),this.mapResize(),void 0!==i&&i.length>0&&this.loadPlugins(i);for(var a in this.menu_items)n=$('<div class="menu-item">'+a+"</div>"),this.loadMenu(n,this.menu_items[a]),r.append(n);this.toolbar.append(r),$(this.node).append($('<div class="popup-overlay"></div><div class="popup-content"></div>')),$(this.node).find(".popup-overlay").click(this,function(e){e.data.hidePopup()}),$(window).resize(this,this.mapResize)},this.loadMenu=function(e,t){var i,n=$("<ul></ul>");for(var o in t)submenu_element=$("<li>"+o+"</li>"),"function"==typeof t[o]&&submenu_element.click({editor:this,element:t[o]},function(e){e.data.element(e.data.editor)}),n.append(submenu_element);i=function(e){$(e.target).hasClass("selected")||e.data.showMenu(e.target)},e.click(this,function(e){e.data.showMenu(e.target),e.data.menu.find(".menu-item").mouseenter(e.data,i)}),this.toolbar.mouseleave(this,function(e){e.data.hideMenu(),e.data.menu.find(".menu-item").unbind("mouseenter",i)}),n.hide(),e.append(n)},this.showMenu=function(e){this.hideMenu(),$(e).addClass("selected"),$(e).find("ul").show()},this.hideMenu=function(){this.menu.find("ul").hide(),this.menu.find(".menu-item").removeClass("selected")},this.loadFooter=function(){a=$('<div class="footer"></div>'),this.node.append(this.footer)},this.mapViewport=function(){var e;e=$('<div class="map-wrapper"></div>'),this.map_viewport.append(e),this.toolbar.after(this.map_viewport),n=new Renderer(e,this.map),this.renderer.render(this.properties.current_spread)},this.mapResize=function(t){var i=void 0===t?this:t.data,n=i.map_viewport.find(".map-wrapper"),o=(i.map_viewport.outerWidth(!0)-i.map_viewport.width(),i.map_viewport.outerHeight(!0)-i.map_viewport.height());i.map_viewport.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)-o),i.left_pannel.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)),i.right_pannel.css("height",i.node.height()-i.toolbar.outerHeight(!0)-i.footer.outerHeight(!0)),$(n).css("line-height",$(n).height()+"px"),i.renderer.resizeMap(),e.trigger("change")},this.loadPlugins=function(e){for(var t,i=e.length-1;i>=0;i--)t=new e[i],t.load(this),this.plugins.push(t)},this.clearPopup=function(){$(this.node).find(".popup-content").html("")},this.hidePopup=function(){$(this.node).find(".popup-content, .popup-overlay").hide()},this.displayPopup=function(){$(this.node).find(".popup-content, .popup-overlay").show()},this.ckeditorPopup=function(e){this.clearPopup();var e=$(this.node).find(".popup-content").append("<textarea>"+(void 0===e?"":e)+"</textarea>");$(e).find("textarea").ckeditor({resize_enabled:!1,removePlugins:"elementspath",height:"100%",width:"100%",toolbar:[{name:"document",groups:["mode","document","doctools"],items:["Source","-","Save","Preview"]},{name:"styles",items:["Styles"]},{name:"basicstyles",groups:["basicstyles","cleanup"],items:["RemoveFormat"]},{name:"insert",items:["SpecialChar"]},{name:"tools",items:["Maximize","ShowBlocks"]}]}),this.displayPopup()},this.__defineGetter__("node",function(){return e}),this.__defineGetter__("map",function(){return t}),this.__defineGetter__("toolbar",function(){return o}),this.__defineGetter__("map_viewport",function(){return s}),this.__defineGetter__("left_pannel",function(){return d}),this.__defineGetter__("right_pannel",function(){return p}),this.__defineGetter__("footer",function(){return a}),this.__defineGetter__("menu",function(){return r}),this.__defineGetter__("properties",function(){return h}),this.__defineGetter__("menu_items",function(){return u}),this.__defineGetter__("renderer",function(){return n}),this.__defineGetter__("plugins",function(){return l}),this.__defineSetter__("node",function(t){e=t}),this.__defineSetter__("map",function(e){t=e}),void 0!==e&&void 0!==t&&this.load(e,t,i)}